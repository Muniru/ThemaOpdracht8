---
title: "Week_Opdracht3"
author: "Muniru & Sam"
date: '2022-05-16'
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Week Opdracht 3

## Assignment 1

### Code

```{r input data}
library(deSolve)
library(ggplot2)

data <- read.csv("data/MPL.csv", na.strings = "NA")
median_MPL_01 <- median(data$MPL_conc[data$dose==0.1], na.rm=T)
median_MPL_03 <- median(data$MPL_conc[data$dose==0.3], na.rm=T)


# Define the parameters
volume_D <- median_MPL_03
nmol <- volume_D * 1000 * (1 / 374.477) 
parameters <- c(Kd_Rm = 0.612, Kre = 0.57, Ks_Rm = 2.90, IC50_Rm = 26.2, 
                Kd_R = 0.0572, Rf = 0.49, Kon= 0.00329,
                Kt = 0.63, D=nmol, Ks_r = 3.22)

# The model we will use
model <- function(t, y, parms){
  with(as.list(c(y, parms)),{
    # Concentratie Receptor mRNA
    dmRNA.R_dt <- Ks_Rm * (1 - (DRN/(IC50_Rm+DRN))) - Kd_Rm * mRNA.R
    
    # Het basisniveau van de concentratie vrije receptor
    dR_dt <- Ks_r* mRNA.R + Rf * Kre * DRN - Kon * D * R - Kd_R * R
    
    # De dichtheid van het MPL-receptor complex
    dDR_dt <- Kon * D * R - Kt * DR
    
    # De hoeveelheid MPL-receptor complex in de celkern
    dDRN_dt <- Kt * DR - Kre * DRN
    
    return(list(c(dmRNA.R_dt, dR_dt, dDR_dt, dDRN_dt)))
    })
}

# Initial values
state <- c(mRNA.R = 4.74,
           R = 267,
           DR = 0,
           DRN = 0)

times <- seq(0,
             168,
             by = 1)

# Using the model with our parameters and initial values
out  <- ode(times = times,
            y = state,
            parms = parameters,
            func = model, 
            method = "euler")
out1 <- data.frame(out)

volume_D <- median_MPL_01
nmol <- volume_D * 1000 * (1 / 374.477) 
parameters <- c(Kd_Rm = 0.612, Kre = 0.57, Ks_Rm = 2.90, IC50_Rm = 26.2, 
                Kd_R = 0.0572, Rf = 0.49, Kon= 0.00329,
                Kt = 0.63, D=nmol, Ks_r = 3.22)

# Using the model with our parameters and initial values
out  <- ode(times = times,
            y = state,
            parms = parameters,
            func = model, 
            method = "euler")
out <- data.frame(out)
plot(out1$mRNA.R)
lines(out$mRNA.R, col="red")

medians <- aggregate(data[,c("MPL_conc","mRNA","Free_receptor")],list(data$dose,data$time), median, na.rm=T)
names(medians)[1:2] <- c("dose","time")

md <- aggregate(data$mRNA,list(data$time), median, na.rm=T)

names(md)[1:2] <- c("time", "median")

ggplot() + geom_point(data, mapping=aes(x=time, y=mRNA)) + geom_line(out, mapping=aes(x=time, y=mRNA.R)) + geom_line(md, mapping = aes(x=time, y=median))
  
```

### Questions

[1] Why is it best practice to plot the median for the experimental data? Explain in your report

    In experimentele data kunnen snel uitschieters voorkomen. Als je het 
    gemmiddelde zal pakken dan wil zal dit verder uitwijken. daarom is het meer 
    betrouwbaar om het mediaan te pakken.

[2] How do the results of the simulations depend on the dose and concentration of the drug? Compare the model variables mRNA, R with the experimental data by running the simulations adjusting dosis D and plot these to find the answer.

    Wanneer de dosis hogere(0.3) is wordt de mrna transcriptie meer geremd dan 
    met een lagere dosis. Het aantal vrije receptoren neemt sneller af met een 
    hogere dosis.

[3] Are the results of the model in line with experimental data? If not, what could be the reason? Think of at least one explanation. Try to test it with simulations (you will get bonus points for that, your explanation does not need to be correct, but should be logical).

    Ja, Dat is te herleiden uit het figuur. Daar is te zien dat de waarden 
    gegroepeerd dalen via dezelfde tijdseenheid als bij het model. 

## Assignment 2

### Code

```{r}
# Paramaters
parameters <- c(Kd_Rm = 0.612, Kre = 0.57, Ks_Rm = 2.90, IC50_Rm = 26.2, 
                Kd_R = 0.0572, Rf = 0.49, Kon= 0.00329,
                Kt = 0.63, D=20*1000/374.471, Ks_r = 3.22)

# Initial values
state <- c(mRNA.R = 4.74,
           R = 267,
           DR = 0,
           DRN = 0)

times <- seq(0,
             168,
             by = 1)

```

### Questions

[1] What would be the time course concentration of the activated drug-receptor complex if there was no auto-regulation of glucocorticoid receptor, i.e. if there was not effect of drug on the synthesis of the receptor mRNA? What formula needs to be changed? Adjust the model, run the simulation and plot the results to find out.

```{r}
# The model we will use
model <- function(t, y, parms){
  with(as.list(c(y, parms)),{
    # Concentratie Receptor mRNA
    dmRNA.R_dt <- Ks_Rm - Kd_Rm * mRNA.R
    
    # Het basisniveau van de concentratie vrije receptor
    dR_dt <- Ks_r* mRNA.R + Rf * Kre * DRN - Kon * D * R - Kd_R * R
    
    # De dichtheid van het MPL-receptor complex
    dDR_dt <- Kon * D * R - Kt * DR
    
    # De hoeveelheid MPL-receptor complex in de celkern
    dDRN_dt <- Kt * DR - Kre * DRN
    
    return(list(c(dmRNA.R_dt, dR_dt, dDR_dt, dDRN_dt)))
    })
}


output  <- ode(times = times,
            y = state,
            parms = parameters,
            func = model, 
            method = "euler")

output <- data.frame(output)

# Data plotting
ggplot() +
  geom_line(output, mapping = aes(x=time, y=mRNA.R))
```

    Als er geen auto regulatie zou zijn zal betegenen dat de aanmaak van mrna constant zou zijn. Door de inhibitie weg te halen uit het model is dit ook te zien. Zoals hieronder te zien is is formule 1 is wat we van het originele model. Deze hebben we aangepast. De regulatie wordt weergegeven in het models als formule 2. Door dit eruit te halen wordt de regulatie achterwegen gelaten. Het resultaat is te zien bij formule 3.

1.  $$ \frac {dmRNA_{R}}{dt} = k_{s\_Rm}\ \biggl(1-\frac {DR(N)}{IC_{50\_Rm} +DR(N)}\biggr) - k_{d\_Rm} * mRNA_{R} $$

2.  $$\biggl(1-\frac {DR(N)}{IC_{50\_Rm} +DR(N)}\biggr)$$

3.  $$ \frac {dmRNA_{R}}{dt} = k_{s\_Rm}\ - k_{d\_Rm} * mRNA_{R} $$

[2] What is the time course of receptor and mRNA concentrations when the drug treatment is stopped? So After the steady state is reached (at time t_steady), D should be set to zero and the simulation should continue from time t_steady till the new steady state is reached (t_steady_second). Run the simulations and plot the results from t = 0 till t_steady_second.

```{r}
# The model we will use
model <- function(t, y, parms){
  with(as.list(c(y, parms)),{
    # Concentratie Receptor mRNA
    dmRNA.R_dt <- Ks_Rm * (1 - (DRN/(IC50_Rm+DRN))) - Kd_Rm * mRNA.R
    
    # Het basisniveau van de concentratie vrije receptor
    dR_dt <- Ks_r* mRNA.R + Rf * Kre * DRN - Kon * D * R - Kd_R * R
    
    # De dichtheid van het MPL-receptor complex
    dDR_dt <- Kon * D * R - Kt * DR
    
    # De hoeveelheid MPL-receptor complex in de celkern
    dDRN_dt <- Kt * DR - Kre * DRN
    
    return(list(c(dmRNA.R_dt, dR_dt, dDR_dt, dDRN_dt)))
    })
}

# Initial Values
parameters_1 <- c(Kd_Rm = 0.612, Kre = 0.57, Ks_Rm = 2.90, IC50_Rm = 26.2, 
                Kd_R = 0.0572, Rf = 0.49, Kon= 0.00329,
                Kt = 0.63, D=20*1000/374.471, Ks_r = 3.22)


state_1 <- c(mRNA.R = 4.74,
           R = 267,
           DR = 0,
           DRN = 0)

times_1 <- seq(0,
             66,
             by = 1)


output  <- data.frame(ode(times = times_1,
            y = state_1,
            parms = parameters_1,
            func = model, 
            method = "euler"))

# Second Values
parameters_2 <- c(Kd_Rm = 0.612, Kre = 0.57, Ks_Rm = 2.90, IC50_Rm = 26.2, 
                Kd_R = 0.0572, Rf = 0.49, Kon= 0.00329,
                Kt = 0.63, D=0, Ks_r = 3.22)


times_2 <- seq(66,
             168,
             by = 1)

t_steady1 <- c(output[67,])

state_2 <- c(mRNA.R = t_steady1$mRNA.R,
           R = t_steady1$R,
           DR = t_steady1$DR,
           DRN = t_steady1$DRN)
# Second Run
output_2 <-  data.frame(ode(times = times_2,
            y = state_2,
            parms = parameters_2,
            func = model, 
            method = "euler"))


# Data plotting
ggplot() +
  geom_line(output, mapping = aes(x=time, y=mRNA.R)) +
  geom_line(output_2, mapping = aes(x=time, y=mRNA.R)) 

ggplot() +
  geom_line(output, mapping = aes(x=time, y=R)) +
  geom_line(output_2, mapping = aes(x=time, y=R)) 

ggplot() +
  geom_line(output, mapping = aes(x=time, y=DR)) +
  geom_line(output_2, mapping = aes(x=time, y=DR)) 

ggplot() +
  geom_line(output, mapping = aes(x=time, y=DRN)) +
  geom_line(output_2, mapping = aes(x=time, y=DRN)) 

```

[3] Different corticosteroids show different association rates from receptors (kon) and different dissociation rates (in this model reflected by kre). Assuming the same concentrations of the drug, what is the effect of different values of kon and kre (consider 2 and 5 times increase and decrease of both parameters separately) on the receptor and mRNA dynamics? Adjust kon and kre as below and plot the results of the simulation for each change. Note: Simulations should be run for 4 new values of kon: 0.00329/5, 0.00329/2, 0.00329*2 and 0.00329*5. The results should be compared to the basic scenario when kon=0.00329 Separately, simulations should be run for 4 new values of kre: 0.57/5, 0.57/2, 0.57*2 and 0.57*5. The results should be compared to the basic scenario when kre= 0.57.
```{r}
# Initial values
state <- c(mRNA.R = 4.74,
           R = 267,
           DR = 0,
           DRN = 0)

times <- seq(0,
             168,
             by = 1)

kon_var <-c(0.00329/5,
         0.00329/2,
         0.00329*2,
         0.00329*5)

plot_series <- function(y_kon=0.00329){
  
    parameters <- c(Kd_Rm = 0.612, Kre = 0.57, Ks_Rm = 2.90, IC50_Rm = 26.2, 
                Kd_R = 0.0572, Rf = 0.49, Kon= y_kon,
                Kt = 0.63, D=20*1000/374.471, Ks_r = 3.22)
  

  output  <- data.frame(ode(times = times,
              y = state,
              parms = parameters,
              func = model, 
              method = "euler"))
  
  # Data plotting
  print(ggplot() +
    geom_line(output, mapping = aes(x=time, y=mRNA.R)))
  
  ggplot() +
    geom_line(output, mapping = aes(x=time, y=R))
}

lapply(kon_var, plot_series)
```

[4] What would happen if the synthesis of the receptor was completely blocked? Which parameter needs to be put to zero? Adjust the parameter, run the simulations and plot the results.

[5] What is the dynamic of the system when the baseline rate of production of mRNA of the receptor is increased or decreased 2 or 5 fold (recalculate the rate of mRNA degradation so that the steady-state assumption at baseline (without the drug) is still valid, i.e. mRNA levels are constant when there is not drug)? Mind you: ks_Rm values should be changed, but we know that if without the drug the system is at steady-state then kd_Rm = ks_Rm/Rm0. Therefore if we change ks_Rm we need to change kd_Rm as well. Also after we recalculate the value of kd_Rm for the baseline conditions, the simulations should be run with drug present. Simulations should be run for 4 different scenarios:

-   ks_Rm = 2.9/5 and kd_Rm=2.9/5/4.74
-   ks_Rm = 2.9/2 and kd_Rm=2.9/2/4.74
-   ks_Rm = 2.9*2 and kd_Rm=2.9*2/4.74
-   ks_Rm = 2.9*5 and kd_Rm=2.9*5/4.74
